{"version":3,"sources":["..\\..\\..\\..\\..\\..\\..\\assets\\scripts\\hall\\game\\gameOver/assets\\scripts\\hall\\game\\gameOver\\ProtectScoreLayer.js"],"names":["Resources","require","GameCfg","cc","Class","extends","Component","properties","timer_bg","default","type","Node","timer_label","Label","onEnable","show","windowSize","view","getVisibleSize","node","getChildByName","setContentSize","onDisable","unschedule","m_waitCallback","init","sn","score","m_totalTime","m_sn","m_score","active","self","string","bind","schedule","runAction","repeatForever","rotateBy","onShareClicked","HallResources","sys","browserType","wx","shareAppMessage","title","imageUrl","protectScoreShareImgUrl","success","res","shareTickets","undefined","setTimeout","showRewardTips","console","log","length","commonShareTickets","getShareInfo","shareTicket","requestProtectScore","encryptedData","iv","fail","myOpenId","WeixinManager","getInstance","userInfo","openid","httpCallback","data","removeLoading","jsonObject","JSON","parse","nRetCode","parseInt","RetCode","TSCommon","dispatchEvent","PROTECT_SCORE_SUCCESS","getProtectScoreShareReward","onCloseBtnClicked"],"mappings":"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","file":"ProtectScoreLayer.js","sourceRoot":"..\\..\\..\\..\\..\\..\\..\\assets\\scripts\\hall\\game\\gameOver","sourcesContent":["/**\r\n * 分享保分界面\r\n */\r\n\r\nvar Resources = require(\"Resources\");\r\nimport {TSCommon} from \"../../TSCommon\";\r\nimport {WeixinManager} from \"../../weixin/WeixinManager\"\r\nvar GameCfg = require(\"GameCfg\");\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        timer_bg: {\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n        timer_label:{\r\n            default: null,\r\n            type: cc.Label,\r\n        },\r\n    },\r\n\r\n\r\n    onEnable: function () {\r\n        this.show();\r\n\r\n        var windowSize=cc.view.getVisibleSize();\r\n        //主界面不显示\r\n        if (this.node.getChildByName(\"mask_bg\"))\r\n        {\r\n            this.node.getChildByName(\"mask_bg\").setContentSize(windowSize);\r\n        }\r\n    },\r\n\r\n    onDisable:function(){\r\n        this.unschedule(this.m_waitCallback);\r\n    },\r\n\r\n    init: function (sn, score) {\r\n        this.m_totalTime = 7;\r\n\r\n        this.m_sn = sn;     //本局的流水号\r\n\r\n        this.m_score = score;    //本局结束的分数\r\n\r\n        this.node.getChildByName(\"give_up_btn\").active = false;\r\n    },\r\n\r\n    show: function () {\r\n\r\n        var self = this;\r\n\r\n        this.m_waitCallback = function(){\r\n\r\n            self.m_totalTime -= 1;\r\n\r\n            self.timer_label.string = self.m_totalTime\r\n\r\n            if(self.m_totalTime < 0){\r\n                self.node.active = false;\r\n            }\r\n\r\n            if(self.m_totalTime <= 3){\r\n\r\n                self.node.getChildByName(\"give_up_btn\").active = true;\r\n\r\n            }\r\n        }.bind(this);\r\n\r\n        this.schedule(this.m_waitCallback, 1, this.m_totalTime, 0);\r\n\r\n       this.timer_bg.runAction(cc.repeatForever(cc.rotateBy(1.0, 360)));\r\n    },\r\n\r\n    onShareClicked: function () {\r\n        var self = this;\r\n        var HallResources = require(\"HallResources\");\r\n        if (cc.sys.browserType == \"mqqbrowser\" || \"wechatgame\" == cc.sys.browserType) {\r\n\r\n            //主动拉起分享接口\r\n            wx.shareAppMessage({\r\n                title: \"[有人@你]保本就靠你了！老铁，忍心见死不救吗！\",\r\n                imageUrl: HallResources.protectScoreShareImgUrl,\r\n                success(res) {\r\n                    if(res.shareTickets == null || res.shareTickets == undefined || res.shareTickets == \"\"){ //没有群信息，说明分享的是个人\r\n                        setTimeout(function(){\r\n                            Resources.showRewardTips(\"请选择一个群进行分享\", true, true, true);\r\n                        }, 0)                       \r\n                    }else{ //有群信息\r\n                        console.log(\"下面是群消息数据!!!\")\r\n                        console.log(res);\r\n                        if(res.shareTickets.length > 0){ \r\n                            self.commonShareTickets = res.shareTickets[0];\r\n                            wx.getShareInfo({\r\n                                shareTicket: self.commonShareTickets,\r\n                                success: function (res) {\r\n                                    console.log(\"下面是群消息唯一性数据!!!\")\r\n                                    console.log(res);\r\n                                    self.requestProtectScore(res.encryptedData,res.iv);\r\n                                }\r\n                            })\r\n                        }\r\n                    }\r\n                },\r\n                fail(res) {\r\n                    console.log(\"分享保分失败!!!\")\r\n                }\r\n            })\r\n        }\r\n    },\r\n\r\n    requestProtectScore: function (encryptedData, iv) {\r\n        var myOpenId = WeixinManager.getInstance().userInfo.openid;\r\n        var self = this;\r\n        var httpCallback = function(success, data){\r\n            require('HallResources').getInstance().removeLoading();\r\n            if(success){\r\n                var jsonObject = JSON.parse(data);\r\n                console.log(\"分享保分 ---------jsonObject --------\");\r\n                console.log(jsonObject);\r\n                var nRetCode = parseInt(jsonObject.RetCode)\r\n                if(nRetCode == 1){\r\n                    Resources.showRewardTips(\"分享成功\", true, true, true);\r\n\r\n                    self.node.active = false;\r\n\r\n                    TSCommon.dispatchEvent(GameCfg.PROTECT_SCORE_SUCCESS, null);    \r\n                }\r\n                else if(nRetCode == 12){\r\n                    Resources.showRewardTips(\"分享次数已经达到上限\", true, true, true);\r\n                }\r\n                else if(nRetCode == 13){\r\n                    Resources.showRewardTips(\"该群已分享过一次，请选择其他群进行分享\", true, true, true);\r\n                }\r\n                else{\r\n                    console.log(\"未对应的错误码错误\");\r\n                }\r\n\r\n                \r\n            }\r\n        }\r\n\r\n        require('HallWebRequest').getInstance().getProtectScoreShareReward(this.m_sn, this.m_score, myOpenId, encryptedData, iv, httpCallback);\r\n    },\r\n\r\n    onCloseBtnClicked: function () {\r\n        this.node.active = false;\r\n    },\r\n\r\n});\r\n"]}