{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\scripts\\login/assets\\scripts\\login\\LoginButtonMenu.js"],"names":["HallResources","require","cc","Class","extends","Component","m_onWxGameLoginCallBack","properties","loginLayer","default","type","Node","loadingLayer","guestBtn","Button","weixinBtn","loading_label","loading_bar","pregress","isLoading","m_timer_ping","onLoad","TSCommon","addEvent","onLoginFinish","onLoginFinished","getComponent","ProgressBar","progress","active","self","isIPhoneX","sys","isNative","isMobile","canvasFit","node","Canvas","fitHeight","fitWidth","loader","loadRes","SpriteFrame","error","spriteframe","bgSp","getChildByName","Sprite","spriteFrame","DEBUG","x","log","judeIsPhoneWXGameBrowser","onWxGameLoginCallBack","weixinUserInfo","WeixinManager","getInstance","userInfo","loginByIMEI","openid","nickName","avatarUrl","Domain","WEIXIN_APPID","onGeWXtUserInfoLogin","checkLogin","unionid","nickname","imei","localStorage","getItem","lastNumber","i","Math","floor","random","setItem","startPreloading","recordPlayerLogToServer","recordList","main_res_start","onProgress","completedCount","totalCount","item","loadResDir","err","assets","onLoadComplete","director","loadScene","main_res_end","onDestroy","removeEvent","update","dt","Label","string","guestButton","event","weiXinButton"],"mappings":"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","file":"LoginButtonMenu.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\login","sourcesContent":["import {ByteArray} from \"../hall/common/ByteArray\";\r\nimport {Domain} from \"../hall/Domain\";\r\nimport {WeixinManager} from \"../hall/weixin/WeixinManager\";\r\nimport { TSCommon } from \"../hall/TSCommon\";\r\nvar HallResources = require('HallResources');\r\ncc.Class({\r\n    extends: cc.Component,\r\n    m_onWxGameLoginCallBack:null,\r\n    properties: {\r\n\r\n        loginLayer:{\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n\r\n        loadingLayer:{\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n\r\n        guestBtn: {\r\n            default: null,\r\n            type: cc.Button\r\n        },\r\n        weixinBtn: {\r\n            default: null,\r\n            type: cc.Button\r\n        },\r\n\r\n        loading_label: {\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n\r\n        loading_bar:{\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n        pregress: 0.0,\r\n        isLoading: false,\r\n\r\n        m_timer_ping:0,\r\n        \r\n    },\r\n\r\n    onLoad:function() {\r\n\r\n        TSCommon.addEvent(HallResources.onLoginFinish, this.onLoginFinished, this);\r\n\r\n\r\n        this.loading_bar.getComponent(cc.ProgressBar).progress = 0.0;\r\n\r\n        this.loadingLayer.active = false;\r\n\r\n        this.loginLayer.active = false;\r\n\r\n        var self = this;\r\n        if(require(\"HallUtils\").isIPhoneX())\r\n        {   \r\n            if(!cc.sys.isNative && cc.sys.isMobile){\r\n                var canvasFit = this.node.getComponent(cc.Canvas);\r\n                canvasFit.fitHeight = true;\r\n                canvasFit.fitWidth = false;\r\n            }\r\n\r\n            cc.loader.loadRes(\"texture/loginRes/loginbg_x\", cc.SpriteFrame,function (error, spriteframe)\r\n            {\r\n                var bgSp = self.node.getChildByName('login_bg_sp').getComponent(cc.Sprite);\r\n                if (!error) {\r\n                    bgSp.spriteFrame = spriteframe;\r\n                }\r\n            });\r\n        }\r\n        \r\n\r\n        var DEBUG = true;\r\n        this.guestBtn.node.active = false;\r\n        if(DEBUG)\r\n        {\r\n            this.guestBtn.node.active = true;\r\n            this.loginLayer.active = true;\r\n        }\r\n        else\r\n        {\r\n            this.weixinBtn.node.x=0;\r\n        }\r\n\r\n        TSCommon.log(\"LoginButtonMenu.onLoad\");\r\n        if(!cc.sys.isNative && require(\"HallUtils\").judeIsPhoneWXGameBrowser())    //在微信小游戏的环境\r\n        {\r\n            this.loginLayer.active = false;\r\n            this.node.getChildByName(\"tips_laebl\").active = true;\r\n            var onWxGameLoginCallBack = function()\r\n            {\r\n                var weixinUserInfo = WeixinManager.getInstance().userInfo;\r\n                if(!weixinUserInfo)\r\n                    return;\r\n                require('HallControl').getInstance().loginByIMEI(weixinUserInfo.openid,weixinUserInfo.nickName,weixinUserInfo.avatarUrl,Domain.WEIXIN_APPID,weixinUserInfo.openid);\r\n            }\r\n            this.m_onWxGameLoginCallBack = onWxGameLoginCallBack;\r\n            TSCommon.addEvent(TSCommon.onGeWXtUserInfoLogin, onWxGameLoginCallBack,this);\r\n\r\n            WeixinManager.getInstance().checkLogin(false);\r\n            var weixinUserInfo = WeixinManager.getInstance().userInfo;\r\n            if(!weixinUserInfo)\r\n                return;\r\n\r\n            require('HallControl').getInstance().loginByIMEI(weixinUserInfo.unionid,weixinUserInfo.nickname,weixinUserInfo.avatarUrl,\"\",\"\");\r\n        }\r\n        else{\r\n            this.loginLayer.active = true;\r\n\r\n            var self = this;\r\n            var imei = \"AfneS1YkaPCAf4zOMqtLhcPGIUm45\"+cc.sys.localStorage.getItem(\"imei\");\r\n            // var imei = \"ofneS1YkaPCAf3zOMqtLhcPGIUm45666999\"//cc.sys.localStorage.getItem(\"imei\");\r\n            if(!imei){\r\n                var lastNumber = \"\";\r\n                for(var i = 0; i < 6; i++){\r\n                    lastNumber += Math.floor(Math.random() * 10)\r\n                }\r\n\r\n                imei = \"ofneS1YkaPCAf3zOMqtLhcPGIUm45\"\r\n                imei += lastNumber;\r\n                cc.sys.localStorage.setItem(\"imei\", imei);\r\n            }\r\n            require('HallControl').getInstance().loginByIMEI(imei,\"Ok\",\"\",\"\",\"\");\r\n        }\r\n    },\r\n\r\n    onLoginFinished:function(){\r\n        this.node.getChildByName(\"tips_laebl\").active = false;\r\n        this.loginLayer.active = false;\r\n        this.loadingLayer.active = true;\r\n        this.startPreloading();\r\n    },\r\n\r\n    startPreloading: function () {\r\n        this.isLoading = true\r\n\r\n        //记录日志\r\n        HallResources.recordPlayerLogToServer(HallResources.recordList.main_res_start);\r\n\r\n\r\n        var self = this;\r\n        cc.loader.onProgress = function (completedCount, totalCount, item) {\r\n            //console.log(\"completedCount:\" + completedCount + \",totalCount:\" + totalCount );\r\n            if (self.isLoading) {\r\n                self.pregress = completedCount / totalCount;         \r\n            }\r\n        };\r\n\r\n        cc.loader.loadResDir(\"resources\", function (err, assets) {\r\n            self.onLoadComplete();\r\n        });\r\n    },\r\n\r\n    onLoadComplete: function () {\r\n        cc.director.loadScene('HallPlatformScene');\r\n        HallResources.recordPlayerLogToServer(HallResources.recordList.main_res_end);\r\n    },\r\n\r\n    onDestroy:function()\r\n    {   \r\n        if(this.m_onWxGameLoginCallBack)\r\n        {\r\n            TSCommon.removeEvent(TSCommon.onGeWXtUserInfoLogin, this.m_onWxGameLoginCallBack,this);\r\n        }\r\n        \r\n        TSCommon.removeEvent(HallResources.onLoginFinish, this.onLoginFinished, this);\r\n    },\r\n\r\n    update: function (dt) {\r\n        if (this.isLoading) {\r\n            this.loading_bar.getComponent(cc.ProgressBar).progress = this.pregress;\r\n            this.loading_label.getComponent(cc.Label).string = Math.floor(this.pregress * 100) + \"%\";\r\n        }\r\n    },\r\n\r\n    //点击游客登录按钮\r\n    guestButton:function(event)\r\n    {\r\n        \r\n    },\r\n\r\n    //点击微信登录按钮\r\n    weiXinButton:function(event)\r\n    {\r\n        if (!WeixinManager.getInstance().checkLogin(true))\r\n            return;\r\n    },\r\n});\r\n"]}