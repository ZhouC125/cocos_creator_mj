{"version":3,"sources":["GameMatchLayer.js"],"names":["HallResources","require","cc","Class","extends","Component","properties","match_status","default","type","Sprite","match_timer","Label","matched_num","match_players","Node","match_success","SpriteFrame","player_avator","unkown_avator","onLoad","init","windowSize","view","getVisibleSize","node","width","height","self","isIPhoneX","loader","loadRes","error","spriteframe","bgSp","getChildByName","getComponent","spriteFrame","m_waitTimer","string","onEnable","m_waitID","repeatRequest","callback","success","data","jsonObject","JSON","parse","console","log","refreshMatchPlayer","table","length","parseInt","RetCode","getInstance","showLoading","nRoomNo","RoomNo","onMathEnd","unschedule","waitTimerCallback","szServerIP","ServerIP","nPort","Port","nChairCount","ChairNum","gameLibSink","m_nChairCount","s_nPrivateRoomTableNo","TableNo","s_nPrivateRoomChairNo","ChairNo","getGameLib","enterGameRoomByIP","enterGameByRoomNo","TSCommon","dispatchEvent","onShowFlyMessage","getMatchResult","bind","schedule","macro","REPEAT_FOREVER","onMatchCloseClicked","onDisable","i","childrenCount","playerSprite","children","setWaitID","waitID","playersArray","showFace","imgUrl","WxFaceUrl","load","url","err","texture","removeLoading","active","exitMatchList"],"mappings":"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","file":"GameMatchLayer.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\hall","sourcesContent":["var HallResources = require(\"HallResources\");\r\nimport {TSCommon} from \"../hall/TSCommon\";\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        match_status: {\r\n            default: null,\r\n            type: cc.Sprite,\r\n        },\r\n\r\n        match_timer: {\r\n            default: null,\r\n            type: cc.Label,\r\n        },\r\n\r\n        //已经匹配成功的人数\r\n        matched_num: {\r\n            default: null,\r\n            type: cc.Label,\r\n        },\r\n\r\n        match_players: {\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n\r\n        match_success: cc.SpriteFrame,\r\n\r\n        player_avator: cc.SpriteFrame,\r\n\r\n        unkown_avator: cc.SpriteFrame,\r\n    },\r\n\r\n    onLoad: function () {\r\n        this.init();\r\n\r\n        var windowSize = cc.view.getVisibleSize();\r\n\r\n        this.node.width = windowSize.width;\r\n        this.node.height = windowSize.height;\r\n\r\n        var self = this;\r\n        if(require(\"HallUtils\").isIPhoneX()){\r\n            cc.loader.loadRes(\"texture/hallRes/iphonex_bg\", cc.SpriteFrame,function (error, spriteframe)\r\n            {\r\n                var bgSp = self.node.getChildByName('hall_bg').getComponent(cc.Sprite);\r\n                if (!error) {\r\n                    bgSp.spriteFrame = spriteframe;\r\n                   \r\n                }\r\n            });\r\n        }\r\n       \r\n    },\r\n\r\n    init: function () {\r\n        this.m_waitTimer = 20;\r\n        this.match_timer.string = this.m_waitTimer;\r\n        this.matched_num.string = 0;\r\n    },\r\n\r\n    onEnable: function () {\r\n\r\n        var self = this;\r\n        if (this.m_waitID) {\r\n            this.init();\r\n\r\n            this.repeatRequest = function () {\r\n                var callback = function (success, data) {\r\n                    if (success) {\r\n                        var jsonObject = JSON.parse(data);\r\n                        console.log(\"jsonObject ===========\");\r\n                        console.log(jsonObject);\r\n\r\n                        self.refreshMatchPlayer(jsonObject.table);\r\n                        self.matched_num.string = jsonObject.table.length;\r\n                        if (parseInt(jsonObject.RetCode) == 1) {\r\n\r\n                            require('HallResources').getInstance().showLoading();\r\n\r\n                            //进入游戏\r\n                            self.match_status.spriteFrame = self.match_success;\r\n\r\n                            var nRoomNo = jsonObject.RoomNo;\r\n\r\n                            var onMathEnd = function(success, data){\r\n                                // require('HallResources').getInstance().removeLoading();\r\n                                self.unschedule(self.repeatRequest);\r\n                                self.unschedule(self.waitTimerCallback);\r\n                                if(success){\r\n                                    \r\n                                    var jsonObject = JSON.parse(data).table[0];\r\n\r\n                                    var szServerIP = jsonObject.ServerIP;\r\n\r\n                                    var nPort = parseInt(jsonObject.Port);\r\n\r\n                                    var nChairCount = parseInt(jsonObject.ChairNum);\r\n\r\n                                    var gameLibSink = require('GameLibSink').getInstance();\r\n\r\n                                    gameLibSink.m_nChairCount = nChairCount;\r\n\r\n                                    gameLibSink.s_nPrivateRoomTableNo = parseInt(jsonObject.TableNo) //无效私人房桌子号\r\n\t\t\t\t\t                gameLibSink.s_nPrivateRoomChairNo = parseInt(jsonObject.ChairNo) //无效私人房椅子号\r\n\r\n                                    gameLibSink.getGameLib().enterGameRoomByIP(szServerIP, nPort);\r\n                                }\r\n                            }\r\n\r\n                            require('HallWebRequest').getInstance().enterGameByRoomNo(nRoomNo, onMathEnd)\r\n                        }\r\n                        else if (parseInt(jsonObject.RetCode) == 11) {  //还没开始点击匹配\r\n                            \r\n                            TSCommon.dispatchEvent(HallResources.onShowFlyMessage,[\"还没开始点击匹配\"]);\r\n                        }\r\n                        else if (parseInt(jsonObject.RetCode) == 12) {  //继续等待\r\n                            \r\n                        }\r\n                        else if (parseInt(jsonObject.RetCode) == 13) {    //房间生成失败\r\n                            TSCommon.dispatchEvent(HallResources.onShowFlyMessage,[\"房间生成失败\"]);\r\n                        }\r\n                        else {\r\n\r\n                        }\r\n                    }\r\n                }\r\n                require('HallWebRequest').getInstance().getMatchResult(self.m_waitID, callback);\r\n            }.bind(self);\r\n\r\n            this.repeatRequest();\r\n\r\n            this.schedule(this.repeatRequest, 2, cc.macro.REPEAT_FOREVER, 0);\r\n\r\n            this.waitTimerCallback = function () {\r\n                self.m_waitTimer -= 1;\r\n                if (self.m_waitTimer >= 0) {\r\n                    self.match_timer.string = self.m_waitTimer;\r\n                }\r\n                else {\r\n                    self.onMatchCloseClicked();\r\n                }\r\n\r\n            }\r\n            this.schedule(this.waitTimerCallback, 1, this.m_waitTimer, 0);\r\n        }\r\n\r\n    },\r\n\r\n\r\n    onDisable: function () {\r\n        this.unschedule(this.repeatRequest);\r\n        this.unschedule(this.waitTimerCallback);\r\n\r\n        for(var i = 0; i < this.match_players.childrenCount; i++){\r\n            var playerSprite = this.match_players.children[i].getChildByName(\"player\").getComponent(cc.Sprite);\r\n            playerSprite.spriteFrame = this.unkown_avator;\r\n        }\r\n    },\r\n\r\n    setWaitID: function (waitID) {\r\n        this.m_waitID = waitID;\r\n    },\r\n\r\n    refreshMatchPlayer: function (playersArray) {\r\n        for(var i = playersArray.length; i < this.match_players.childrenCount; i++){\r\n            var playerSprite = this.match_players.children[i].getChildByName(\"player\").getComponent(cc.Sprite);\r\n            playerSprite.spriteFrame = this.unkown_avator;\r\n        }\r\n\r\n       var self = this;\r\n        var showFace = function(i){\r\n            if (i >= self.match_players.childrenCount || i >= playersArray.length) {\r\n                return;\r\n            }\r\n\r\n            var imgUrl = playersArray[i].WxFaceUrl;\r\n\r\n            if (imgUrl && imgUrl != \"\") {\r\n                var playerSprite = self.match_players.children[i].getChildByName(\"player\").getComponent(cc.Sprite);\r\n                cc.loader.load({ url: imgUrl, type: \"jpg\" }, function (err, texture) {\r\n                    if (!err) {\r\n                        playerSprite.spriteFrame = new cc.SpriteFrame(texture);\r\n                        showFace(i + 1);\r\n                    }\r\n                });\r\n            }\r\n            else {\r\n                var playerSprite = self.match_players.children[i].getChildByName(\"player\").getComponent(cc.Sprite);\r\n                playerSprite.spriteFrame = self.player_avator\r\n                showFace(i + 1);\r\n            }  \r\n        }\r\n\r\n        showFace(0);\r\n    },\r\n\r\n    //关闭匹配\r\n    onMatchCloseClicked: function () {\r\n        var self = this;\r\n        var callback = function (success, data) {\r\n            require('HallResources').getInstance().removeLoading();\r\n            var jsonObject = JSON.parse(data);\r\n            if (parseInt(jsonObject.RetCode) == 1) {\r\n                self.node.active = false;\r\n            }\r\n        }\r\n        require('HallWebRequest').getInstance().exitMatchList(callback)\r\n    },\r\n\r\n    // update (dt) {},\r\n});\r\n"]}